"use strict";const c=require("../common/vendor.js");require("./request.js");const m="https://api.coze.cn/v1/files/upload",h="pat_RHaWUG7hVWOpH5iVBFuJ3LTm40BL7Bpjy3Qi2y9cwOuZY0KfTIXHyp3pwNBNSqq5",r=()=>{const i=c.index.getSystemInfoSync().platform;return{platform:i,isWechat:!0,isH5:i==="web"}},u=(i,f={})=>{const p=r();return new Promise((n,o)=>{if(p.isWechat)c.index.uploadFile({url:m,filePath:typeof i=="string"?i:i.path||i.tempFilePath,name:"file",header:{Authorization:`Bearer ${h}`},success:e=>{if(e.statusCode>=200&&e.statusCode<300){let t;try{t=JSON.parse(e.data)}catch{t=e.data}t.code===0?n(t.data):o({statusCode:e.statusCode,errMsg:t.msg||"上传失败",data:t})}else o({statusCode:e.statusCode,errMsg:e.errMsg||"上传失败",data:e.data})},fail:e=>{o(e)}});else if(p.isH5){let e=function(a){c.index.request({url:m,method:"POST",header:{Authorization:`Bearer ${h}`,"Content-Type":"multipart/form-data"},data:a,success:s=>{s.statusCode>=200&&s.statusCode<300?s.data.code===0?n(s.data.data):o({statusCode:s.statusCode,errMsg:s.data.msg||"上传失败",data:s.data}):o({statusCode:s.statusCode,errMsg:s.errMsg||"上传失败",data:s.data})},fail:s=>{o(s)}})};const t=new FormData;if(typeof i=="string"){const a=i.split("/").pop();fetch(i).then(s=>s.blob()).then(s=>{const l=new File([s],a);t.append("file",l),e(t)}).catch(s=>o(s))}else t.append("file",i),e(t)}else c.index.uploadFile({url:m,filePath:typeof i=="string"?i:i.path||i,name:"file",header:{Authorization:`Bearer ${h}`},success:e=>{if(e.statusCode>=200&&e.statusCode<300){let t;try{t=JSON.parse(e.data)}catch{t=e.data}t.code===0?n(t.data):o({statusCode:e.statusCode,errMsg:t.msg||"上传失败",data:t})}else o({statusCode:e.statusCode,errMsg:e.errMsg||"上传失败",data:e.data})},fail:e=>{o(e)}})})};u.chooseAndUploadImage=(i={})=>{const p={...{count:1,sizeType:["original","compressed"],sourceType:["album","camera"]},...i};return new Promise((n,o)=>{c.index.chooseImage({...p,success:async e=>{try{const t=e.tempFilePaths[0],a=await u(t);n(a)}catch(t){o(t)}},fail:e=>{o(e)}})})};u.chooseAndUploadFile=(i={})=>{const f=r(),n={...{count:1,type:"file",extension:[]},...i};return new Promise((o,e)=>{if(f.isWechat)c.index.chooseMessageFile({...n,success:async t=>{try{if(t.tempFiles&&t.tempFiles.length>0){const a=t.tempFiles[0],s=a.name||"未命名文件",l=a.path||a.tempFilePath,d=await u(l);d.fileName=s,o(d)}else e({errMsg:"未选择文件"})}catch(a){e(a)}},fail:t=>{e(t)}});else if(f.isH5){const t=document.createElement("input");t.type="file",n.extension&&n.extension.length>0&&(t.accept=n.extension.join(",")),t.onchange=async a=>{try{if(a.target.files&&a.target.files.length>0){const s=a.target.files[0],l=await u(s);l.fileName=s.name,o(l)}else e({errMsg:"未选择文件"})}catch(s){e(s)}},t.click()}else typeof c.index.chooseFile=="function"?c.index.chooseFile({...n,success:async t=>{try{if(t.tempFiles&&t.tempFiles.length>0){const a=t.tempFiles[0],s=a.name||"未命名文件",l=a.path||a.tempFilePath,d=await u(l);d.fileName=s,o(d)}else e({errMsg:"未选择文件"})}catch(a){e(a)}},fail:t=>{e(t)}}):c.index.chooseMessageFile({...n,success:async t=>{try{if(t.tempFiles&&t.tempFiles.length>0){const a=t.tempFiles[0],s=a.name||"未命名文件",l=a.path||a.tempFilePath,d=await u(l);d.fileName=s,o(d)}else e({errMsg:"未选择文件"})}catch(a){e(a)}},fail:t=>{e(t)}})})};exports.uploadFile=u;
